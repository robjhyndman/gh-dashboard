---
page-title: "Repository Dashboard"
format: dashboard
theme: darkly
execute: 
  echo: false
---

```{r}
library(reactable)

last <- readr::read_csv("last_week.csv")
res <- readr::read_csv("current_week.csv")
green_pal <- function(x) rgb(colorRamp(c("#00cc00", "#ffffff"))(x), maxColorValue = 255)
```

## Row

```{r}
#| content: valuebox
#| title: "R packages"
list(
    icon = "stars",
    color = "#0000cc",
    value = sum(repos$type == "R package")
)
```

```{r}
#| content: valuebox
#| title: "Quarto extensions"
list(
    icon = "stars",
    color = "#0000cc",
    value = sum(repos$type == "Quarto extension")
)
```

```{r}
#| content: valuebox
#| title: "New Stars"
list(
    icon = "stars",
    color = "#DBAC34",
    value = sum(res$stars) - sum(last$stars)
)
```

```{r}
#| content: valuebox
#| title: "New issues"
list(
    icon = "stars",
    color = "#cc0000",
    value = sum(res$open_issues) - sum(last$open_issues)
)
```

## Row

```{r}
# res$last_push <- as.character(lubridate::as_datetime(res$last_push))
# res$last_issue_activity <- as.character(lubridate::as_datetime(res$last_issue_activity))

reactable(
    res,
    defaultSorted = list(last_issue_activity = "desc"),
    columns = list(
        owner = colDef(name = "Owner"),
        repo = colDef(name = "Repository"),
        last_push = colDef(
            name = "Last Push",
            format = colFormat(datetime = TRUE),
            style = function(value) {
                normalized <- pmin(difftime(Sys.time(), value, units = "days") / 365, 1)
                color <- green_pal(normalized)
                list(background = color, color = "black")
            }
        ),
        stars = colDef(name = "Stars"),
        forks = colDef(name = "Forks"),
        open_issues = colDef(name = "Open Issues"),
        last_issue_activity = colDef(
            name = "Last Issue Activity",
            format = colFormat(datetime = TRUE),
            style = function(value) {
                color <- ifelse(difftime(Sys.time(), value, units = "days") <= 7, "#cc0000", "#2D2D2D")
                color[is.na(color)] <- "#2D2d2D"
                list(background = color)
            }
        )
    ),
    defaultPageSize = nrow(repos),
    theme = reactableTheme(backgroundColor = "#2D2D2D")
)
```